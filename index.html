<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Screen Share PoC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 1rem;
        }
        .card {
            background-color: #2a2a2a;
            border-radius: 0.75rem;
            padding: 2rem;
            border: 1px solid #444;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }
        .btn-primary:hover:not(:disabled) {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #4b5563;
            color: white;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #374151;
        }
        .btn-danger {
            background-color: #ef4444;
            color: white;
        }
        .btn-danger:hover:not(:disabled) {
            background-color: #dc2626;
        }
        input[type="text"] {
            background-color: #1e1e1e;
            color: #d4d4d4;
            border: 1px solid #555;
            width: 100%;
            border-radius: 0.5rem;
            padding: 0.75rem;
            font-family: monospace;
        }
        video {
            width: 100%;
            border-radius: 0.5rem;
            background-color: #000;
        }
        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem auto;
            width: 280px;
            height: 280px;
        }
        .step {
            padding: 0.5rem 1rem;
            background-color: #3b82f6;
            color: white;
            border-radius: 9999px;
            font-weight: bold;
            min-width: 32px;
            height: 32px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-right: 0.75rem;
        }
        .room-id {
            font-family: monospace;
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
            background-color: #1e1e1e;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #555;
            text-align: center;
            letter-spacing: 2px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="flex justify-between items-center mb-2">
                <h1 class="text-3xl font-bold text-center">Local Screen Share</h1>
                <button id="resetBtn" class="btn btn-danger hidden">Start Over</button>
            </div>
            <p class="text-center text-gray-400 mb-6">PWA PoC for Phone â†’ PS4</p>
            
            <!-- Initial View -->
            <div id="initialView" class="text-center space-y-4">
                <p>Choose your role for this device:</p>
                <div class="flex flex-col sm:flex-row justify-center gap-4">
                    <button id="startSender" class="btn btn-primary">ðŸ“± Share Video (Phone)</button>
                    <button id="startReceiver" class="btn btn-secondary">ðŸŽ® Receive Stream (PS4)</button>
                </div>
            </div>

            <!-- Sender View (Phone) -->
            <div id="senderView" class="hidden space-y-6">
                 <div>
                    <h2 class="text-xl font-semibold flex items-center"><span class="step">1</span>Enter Room ID from PS4</h2>
                    <p class="text-gray-400 ml-12 mb-4">Scan the simple QR code on the PS4 screen and enter the Room ID below.</p>
                    <div class="ml-12">
                        <input type="text" id="roomIdInput" placeholder="Enter Room ID...">
                    </div>
                    <div class="ml-12 mt-4 flex flex-wrap gap-2">
                        <button id="createAnswerBtn" class="btn btn-primary" disabled>Share Screen</button>
                        <button id="createCameraAnswerBtn" class="btn btn-secondary" disabled>Share Camera</button>
                    </div>
                </div>
            </div>

            <!-- Receiver View (PS4) -->
            <div id="receiverView" class="hidden space-y-6 text-center">
                <h2 class="text-xl font-semibold flex items-center justify-center"><span class="step">1</span>Scan this QR on your Phone</h2>
                <p class="text-gray-400 mb-4">A simple Room ID and QR code will appear below. Scan it with your phone and enter the ID.</p>
                <div id="roomInfo" class="hidden">
                    <p class="room-id" id="roomIdDisplay"></p>
                    <div id="qrcode"></div>
                    <p class="text-gray-400 mt-4">Waiting for phone to connect...</p>
                </div>
            </div>
            
             <!-- Common Elements -->
            <div id="status" class="text-center text-yellow-400 mt-6 font-semibold"></div>
            <video id="videoPlayer" class="mt-4 hidden" autoplay playsinline></video>
        </div>
        <footer class="text-center text-gray-500 mt-4 text-sm">
            <p>Connection is P2P on your local Wi-Fi after a secure handshake.</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- Element Definitions ---
        const initialView = document.getElementById('initialView');
        const senderView = document.getElementById('senderView');
        const receiverView = document.getElementById('receiverView');
        const startSenderBtn = document.getElementById('startSender');
        const startReceiverBtn = document.getElementById('startReceiver');
        const resetBtn = document.getElementById('resetBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const createAnswerBtn = document.getElementById('createAnswerBtn');
        const createCameraAnswerBtn = document.getElementById('createCameraAnswerBtn');
        const roomInfo = document.getElementById('roomInfo');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const qrcodeContainer = document.getElementById('qrcode');
        const videoPlayer = document.getElementById('videoPlayer');
        const status = document.getElementById('status');
        
        // --- Firebase & WebRTC Globals ---
        let peerConnection;
        let localStream;
        let db;
        let currentRoomId;
        let unsubscribe; // To stop listening to Firestore changes

        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // --- Firebase Initialization ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'screen-share-poc';
        let firebaseConfig;
        try {
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        } catch(e) {
            console.error("Firebase config parsing error:", e);
            status.textContent = "Error: Invalid Firebase configuration.";
        }
        
        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(error => {
                console.error("Anonymous sign-in failed:", error);
                status.textContent = "Error: Could not authenticate.";
            });
        } else {
             status.textContent = "Error: Firebase is not configured.";
        }
       
        // --- Core Functions ---
        async function resetState() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            if (currentRoomId && db) {
                const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
                await deleteDoc(roomRef).catch(e => console.error("Could not delete room doc", e));
                currentRoomId = null;
            }

            initialView.classList.remove('hidden');
            senderView.classList.add('hidden');
            receiverView.classList.add('hidden');
            videoPlayer.classList.add('hidden');
            resetBtn.classList.add('hidden');
            roomInfo.classList.add('hidden');

            roomIdInput.value = '';
            qrcodeContainer.innerHTML = '';
            videoPlayer.srcObject = null;
            status.textContent = '';
            
            createAnswerBtn.disabled = true;
            createCameraAnswerBtn.disabled = true;
        }

        resetBtn.onclick = resetState;
        window.onbeforeunload = resetState;

        // --- Event Listeners ---
        roomIdInput.addEventListener('input', () => {
            const hasText = roomIdInput.value.trim() !== '';
            createAnswerBtn.disabled = !hasText;
            createCameraAnswerBtn.disabled = !hasText;
        });

        // --- Role Selection ---
        startSenderBtn.onclick = () => {
            if (!db) return;
            initialView.classList.add('hidden');
            senderView.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            videoPlayer.classList.remove('hidden');
            status.textContent = "Ready to share video.";
        };

        startReceiverBtn.onclick = async () => {
            if (!db) return;
            initialView.classList.add('hidden');
            receiverView.classList.remove('hidden');
            resetBtn.classList.remove('hidden');
            videoPlayer.classList.remove('hidden');
            status.textContent = "Creating a new room...";

            currentRoomId = generateRoomId();
            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            
            peerConnection = new RTCPeerConnection(configuration);
            
            peerConnection.onicecandidate = async event => {
                if (event.candidate) {
                    await updateDoc(roomRef, { 'offer.candidates': { [Date.now()]: event.candidate.toJSON() } });
                }
            };
            
            peerConnection.ontrack = event => {
                status.textContent = "Stream received!";
                videoPlayer.srcObject = event.streams[0];
                videoPlayer.muted = false;
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            await setDoc(roomRef, { offer: { sdp: offer.sdp, type: offer.type } });
            
            roomIdDisplay.textContent = currentRoomId;
            new QRCode(qrcodeContainer, { text: currentRoomId, width: 256, height: 256 });
            roomInfo.classList.remove('hidden');
            
            unsubscribe = onSnapshot(roomRef, async (snapshot) => {
                const data = snapshot.data();
                if (data && data.answer && !peerConnection.currentRemoteDescription) {
                    status.textContent = "Connecting...";
                    const answer = new RTCSessionDescription(data.answer);
                    await peerConnection.setRemoteDescription(answer);
                }
            });
        };
        
        // --- Sender Logic ---
        const startStreaming = async (streamType) => {
            if (!db) return;
            currentRoomId = roomIdInput.value.trim();
            if (!currentRoomId) {
                status.textContent = "Error: Please enter a Room ID.";
                return;
            }

            const roomRef = doc(db, `artifacts/${appId}/public/data/rooms`, currentRoomId);
            status.textContent = `Requesting ${streamType} access...`;

            try {
                if (streamType === 'screen') {
                    localStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                } else {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                }
                videoPlayer.srcObject = localStream;
                videoPlayer.muted = true;
            } catch (err) {
                 status.textContent = `Error: Could not get ${streamType} stream. Permission denied?`;
                 console.error(err);
                 return;
            }

            peerConnection = new RTCPeerConnection(configuration);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            unsubscribe = onSnapshot(roomRef, (snapshot) => {
                const data = snapshot.data();
                if (data && data.offer && data.offer.candidates) {
                    Object.values(data.offer.candidates).forEach(candidate => {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    });
                }
            });

            const offer = (await onSnapshot(roomRef, s => s).docs[0]?.data())?.offer;
            if (offer) {
                await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                await updateDoc(roomRef, { answer: { sdp: answer.sdp, type: answer.type } });
                status.textContent = "Connection established!";
                senderView.classList.add('hidden');
            } else {
                 status.textContent = "Error: Room not found or offer is missing.";
            }
        };

        createAnswerBtn.onclick = () => startStreaming('screen');
        createCameraAnswerBtn.onclick = () => startStreaming('camera');
        
        function generateRoomId() {
            return `${Math.random().toString(36).substr(2, 4).toUpperCase()}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;
        }
    </script>
</body>
</html>

